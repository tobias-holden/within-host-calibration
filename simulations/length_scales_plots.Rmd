---
title: EMOD Within-Host Calibration Progress
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r, out.width="90%"}
# Setup
library(tidyverse)
library(ggrepel)
library(glue)
library(gtools)
library(reticulate)
library(patchwork)

# experiment name
exp <- "241114_homogeneous"

dir.create(paste("output",exp,"performance",sep="/"))
GP_folder<-paste("output",exp,"performance/GP",sep='/')
if(!(dir.exists(GP_folder))){dir.create(GP_folder)}

# Custom color palette
my_pal <- c("gray",
            RColorBrewer::brewer.pal(8,"Paired"),
            RColorBrewer::brewer.pal(8,'Dark2'),
            RColorBrewer::brewer.pal(8,"Accent"),
            RColorBrewer::brewer.pal(8,"Set1"),
            RColorBrewer::brewer.pal(8,"Set2"),
            RColorBrewer::brewer.pal(8,"Set3"),
            RColorBrewer::brewer.pal(8,"Pastel1"),
            RColorBrewer::brewer.pal(8,"Pastel2"))
my_pal <- c(my_pal,my_pal[-1])
pal_df <-data.frame(color=my_pal)
pal_df$id <- 0:(nrow(pal_df)-1)

theme_set(theme_minimal(base_size=14))
```

### Datasets

```{r}
# Parameters
LFS <- list.dirs(path = glue('output/{exp}'),recursive = F)
LFS <- LFS[grepl("LF",LFS)]

for(i in seq(0,length(LFS)-1,1)){
  if(i==0){
    tp <- read.csv(paste(LFS[i+1],"translated_params.csv",sep='/'))
    tp %>% mutate(round=i) ->  tp
  } else {
    tmp <- read.csv(paste(LFS[i+1],"translated_params.csv",sep='/'))
    tmp %>% mutate(round=i) -> tmp
    tp <- rbind.data.frame(tp,tmp)
  }
}


ls_list <- list.files(glue("output/",exp,"/performance/GP"))
ls_list <- ls_list[grepl("LS",ls_list)]


for(ls in ls_list){
  if(!(exists("LS"))){
    LS <- read.csv(glue(GP_folder,'/',ls))
  } else {
    tmp <- read.csv(glue(GP_folder,'/',ls))
    LS <- rbind.data.frame(LS,tmp)
  }
}
  
  sensitivities <- LS[!duplicated(LS),]
  
  pids <- seq(1,max(sensitivities$id))
  
  plevels <- c(1,5,10,6,11,12,7, # Acquired immune
               21,13,8,14,          # Innate immune
               2,3,4,9,          # gametocyte
               15,16,17,18,19,20)# severe disease
  
sensitivities %>%
    mutate(site=gsub('.{5}$', '', site))%>%
    mutate(metric=gsub("gamet_density","gametocytes",metric)) %>%
    mutate(metric=gsub("asex_density","asexual parasites",metric)) %>%
    ggplot(aes(x=factor(id,levels=plevels,labels=gsub("Base ","",tp$parameter[plevels])),
               y=paste(substr(metric,1,4),substr(site,1,4),sep=". "))) +
    geom_tile(color="white",
              aes(fill=value)) +
    scale_fill_distiller(palette="RdGy",direction = 1) +
    #facet_grid(metric~.,scales="free") +
    xlab("") + ylab("") +
    theme_minimal(base_size=16)+
    theme(axis.text.x=element_text(angle=45,hjust=1)) +
    xlab("") + ylab("") +
    labs(fill=NULL) 
  
  ggsave(paste(GP_folder,"lengthscales.png",sep="/"),width=12,height=8)
  
  sensitivities %>%
    mutate(site=gsub('.{5}$', '', site))%>%
    mutate(metric=gsub("gamet_density","gametocytes",metric)) %>%
    mutate(metric=gsub("asex_density","asexual parasites",metric)) %>%
    mutate(value=percent_rank(value)) %>%
    ggplot(aes(x=factor(id,levels=plevels,labels=gsub("Base ","",tp$parameter[plevels])),
               y=paste(substr(metric,1,4),'.    ',substr(site,1,4),'.',sep=""))) +
    geom_tile(color="white",
              aes(fill=value)) +
    scale_fill_distiller(palette="RdGy",direction = 1) +
    #facet_grid(metric~.,scales="free") +
    xlab("") + ylab("") +
    theme_minimal(base_size=16) +
    theme(axis.text.x=element_text(angle=45,hjust=1)) +
    xlab("") + ylab("") +
    labs(fill=NULL) 
  
  ggsave(paste(GP_folder,"ranked_lengthscales.png",sep="/"),width=12,height=8)
 
  
  sensitivities %>%
    #group_by(site,metric) %>%
    mutate(percentile = percent_rank(value)) %>%
    ungroup() %>%
    group_by(metric,id) %>%
    summarize(value=mean(percentile)) %>%
    ungroup() %>%
    mutate(metric=gsub("gamet_density","[gametocytes]",metric)) %>%
    mutate(metric=gsub("asex_density","[asexual parasites]",metric)) %>% 
    ggplot(aes(y=factor(id,levels=plevels,labels=gsub("\n","",gsub("-\n"," ",tp$parameter[plevels]))),
               x=factor(metric,levels=c("prevalence","[asexual parasites]","[gametocytes]",
                                        "infectiousness","incidence","severe_incidence")))) +
    theme_minimal(base_size=16) +
    geom_tile(color="white",
              aes(fill=value)) +
    #geom_text(aes(label=round(value,1)))+
    scale_fill_distiller(palette="RdGy",direction = 1) +
    theme(axis.text.x=element_text(angle=45,hjust=1),
          axis.text.y=element_text(angle=0)) +
    xlab("") + ylab("") +
    labs(fill=NULL) +
    coord_fixed()
  
  ggsave(paste(GP_folder,"average_ranked_lengthscales.png",sep="/"),width=10,height=6)
    
  sensitivities %>%
    ungroup() %>%
    #mutate(value=1/value)%>%
    group_by(metric,id) %>%
    summarize(value=mean(value)) %>%
    ungroup() %>%
    mutate(metric=gsub("gamet_density","[gametocytes]",metric)) %>%
    mutate(metric=gsub("asex_density","[asexual parasites]",metric)) %>% 
    ggplot(aes(y=factor(id,levels=plevels,labels=gsub("\n","",gsub("-\n"," ",tp$parameter[plevels]))),
               x=factor(metric,levels=c("prevalence","[asexual parasites]","[gametocytes]",
                                        "infectiousness","incidence","severe_incidence")))) +
    theme_minimal(base_size=12) +
    geom_tile(color="white",
              aes(fill=value)) +
    scale_fill_distiller(palette="RdGy",direction = 1) +
    theme(axis.text.x=element_text(angle=45,hjust=1)) +
    xlab("") + ylab("") +
    labs(fill=NULL) +
    coord_fixed() 
  ggsave(paste(GP_folder,"average_lengthscales.png",sep="/"),width=10,height=6)
```


