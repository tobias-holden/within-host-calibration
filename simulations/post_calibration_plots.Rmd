---
title: EMOD Within-Host Calibration Progress
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r, out.width="90%"}
# Setup
library(tidyverse)
library(ggrepel)
library(glue)
library(gtools)
library(reticulate)
library(patchwork)

# experiment name
exp <- ""

coord_df <- read.csv("../simulation_inputs/calibration_coordinator.csv",header = FALSE)
# Number of training batches
training_batches <- coord_df$V2[coord_df$V1=="init_batches"]
# Batch size
batch_size <- coord_df$V2[coord_df$V1=="batch_size"]

dir.create(paste("output",exp,"performance",sep="/"))
score_folder<-paste("output",exp,"performance/scores",sep='/')
if(!(dir.exists(score_folder))){dir.create(score_folder)}
parameters_folder<-paste("output",exp,"performance/parameters",sep='/')
if(!(dir.exists(parameters_folder))){dir.create(parameters_folder)}
search_space_folder<-paste("output",exp,"performance/parameters/search_space",sep='/')
if(!(dir.exists(search_space_folder))){dir.create(search_space_folder)}
GP_folder<-paste("output",exp,"performance/GP",sep='/')
if(!(dir.exists(GP_folder))){dir.create(GP_folder)}
objectives_folder<-paste("output",exp,"objectives",sep='/')
if(!(dir.exists(objectives_folder))){dir.create(objectives_folder)}

# Custom color palette
my_pal <- c("gray",
            RColorBrewer::brewer.pal(8,"Paired"),
            RColorBrewer::brewer.pal(8,'Dark2'),
            RColorBrewer::brewer.pal(8,"Accent"),
            RColorBrewer::brewer.pal(8,"Set1"),
            RColorBrewer::brewer.pal(8,"Set2"),
            RColorBrewer::brewer.pal(8,"Set3"),
            RColorBrewer::brewer.pal(8,"Pastel1"),
            RColorBrewer::brewer.pal(8,"Pastel2"))
my_pal <- c(my_pal,my_pal[-1])
pal_df <-data.frame(color=my_pal)
pal_df$id <- 0:(nrow(pal_df)-1)

theme_set(theme_minimal(base_size=14))
```

### Datasets

```{r}
#### Raw scores
scores <- read.csv(paste("output",exp,'all_LL.csv',sep='/'))
# Identify parameter sets with missing or NA scores
scores %>% group_by(param_set,round) %>% summarize(missing=sum(is.na(ll))) %>% filter(missing>0) -> unscored
# Filter to only scored parameter sets
scores <- scores %>% filter(!(interaction(round,param_set) %in% interaction(unscored$round,unscored$param_set)))
# Grouped by total score (unweighted)
total_scores <- scores %>% group_by(param_set,round) %>% summarize(total_score=sum(ll*my_weight))
# Best set
best_ps = total_scores$param_set[total_scores$total_score==max(total_scores$total_score[!(total_scores$round==0 & total_scores$param_set==1)],na.rm=T)]
best_round=total_scores$round[total_scores$total_score==max(total_scores$total_score[!(total_scores$round==0 & total_scores$param_set==1)],na.rm=T)]
# Grouped by objective scores (unweighted)
objective_scores <- scores %>% group_by(param_set,round,metric) %>%
  summarize(objective_score=sum(ll),n_sites=length(unique(site)))

total_scores %>%
  #filter(!(round==0)) %>%
  group_by(round) %>% filter(total_score==max(total_score)| (param_set==1 & round==0)) %>%
  ungroup() %>% arrange(round) %>%
  mutate(cummax=cummax(total_score)) %>% 
  filter(total_score==cummax| (param_set==1 & round==0)) -> improvements


improvements
# Parameters

scores %>% ungroup() %>% select(round) -> pp

pp %>% group_by(round) %>% count() %>% select(round) ->pp

LFS <- list.dirs(path = glue('output/{exp}'),recursive = F)
LFS <- LFS[grepl("LF",LFS)]

for(i in seq(0,length(LFS)-1,1)){
  if(i==0){
    tp <- read.csv(paste(LFS[i+1],"translated_params.csv",sep='/'))
    tp %>% mutate(round=i) ->  tp
  } else {
    tmp <- read.csv(paste(LFS[i+1],"translated_params.csv",sep='/'))
    tmp %>% mutate(round=i) -> tmp
    tp <- rbind.data.frame(tp,tmp)
  }
}


tp %>% 
  mutate(unit_value=gsub("tensor\\(","",unit_value)) %>%
  mutate(unit_value=gsub("\\)","",unit_value)) %>%
  mutate(unit_value=as.numeric(unit_value)) %>%
  mutate(emod_value=gsub("tensor\\(","",emod_value)) %>%
  mutate(emod_value=gsub("\\)","",emod_value)) %>%
  mutate(emod_value=as.numeric(emod_value)) %>%
  mutate(emod_value=ifelse(transformation=="log",
                           log10(emod_value),
                           emod_value)) %>%
  mutate(parameter=ifelse(transformation=="log",
                          paste("Log10",parameter,sep = " "),
                          parameter))%>%
  mutate(parameter=gsub("_"," ",parameter)) %>%
  mutate(parameter=gsub("Survival Rate","\nSurvival Rate",parameter))%>%
  mutate(parameter=gsub("Inactivation","\nInactivation",parameter))%>%
  mutate(parameter=gsub("Base","",parameter)) %>%
  mutate(parameter=gsub("Falciparum","",parameter)) %>%
  mutate(parameter=gsub("Nonspecific Anti","Nonspecific Anti-\n",parameter)) -> parameters


param_levels <- unique(parameters$parameter)
param_levels <- param_levels[c(1,5,10,7,6,11,12,
                               4,2,9,3,
                               14,13,8,17,15,16)]

# unit values per parameter set
parameters %>% select(parameter,unit_value,param_set,round)%>%spread(parameter,unit_value) -> unit_parameters
# emod values per parameter set
parameters %>% select(parameter,emod_value,param_set,round)%>%spread(parameter,emod_value) -> emod_parameters
# parameter specifications
parameters %>% select(parameter,min,max,team_default,transformation) %>% distinct() -> parameter_key
```

Heterogeneity in selected samples

```{r,eval=F}
total_scores %>% ungroup() %>%
  mutate(rank=rank(-total_score)) %>%
  arrange(rank) %>%
  filter(rank<=100) -> top100

total_scores %>%
  filter(round<training_batches) -> randominit

myparams <- colnames(unit_parameters %>% select(-c(round,param_set)))

if(length(myparams)%%2!=0){
  myparams = c(myparams,myparams[1])
}

for(i in seq(1,length(myparams),1))
{
  for(j in seq(1,length(myparams),1))
  {
    if(i<j)
    {
      unit_parameters %>%
        ggplot(aes(x=!!sym(myparams[i]),
                   y=!!sym(myparams[j]))) +
        geom_point(data=.%>%filter(round<training_batches),
                   aes(color="init"),alpha=0.5) +
        geom_point(data=.%>%right_join(top100),
                   aes(color="top100"),alpha=0.5) +
        coord_fixed() +
        labs(color="Unit Values")+
        scale_color_manual(values=c("gray","red")) ->p
      
      print(p)
      
      #ggsave(paste("~/",paste(i,"vs",j,sep="_"),".png",sep=""),p,height=5,width=6)
      # 
       emod_parameters %>%
        ggplot(aes(x=!!sym(myparams[i]),
                   y=!!sym(myparams[j]))) +
        geom_point(data=.%>%filter(round<training_batches),
                   aes(color="init"),alpha=0.5) +
        geom_point(data=.%>%right_join(top100),
                   aes(color="top100"),alpha=0.5) +
        #coord_fixed() +
        labs(color="EMOD Values")+
        scale_color_manual(values=c("gray","red")) ->p
      print(p)
    }
  }
}

```




### Key Plots

#### Scoring

```{r}
#### Raw scores

# Total scores vs. i
total_scores %>%
  ggplot(aes(x=param_set+round*batch_size,
             y=-total_score)) +
  theme(axis.text.x=element_text(angle=-90)) +
  geom_point() +
  geom_point(data=.%>%filter(round==0&param_set==1),
             aes(color="default"))+
  
  geom_point(data=.%>%filter(round==best_round&param_set==best_ps),
             aes(color="best"))+
  scale_y_log10() +labs(color=NULL) +
  ylab("Total Score") + xlab("i") +
  scale_color_brewer(palette="Set1")

# Objective scores vs. i
objective_scores%>%
  ggplot(aes(x=param_set+round*batch_size,
             y=-objective_score)) +
  theme(axis.text.x=element_text(angle=-90)) +
  geom_point()  +
  facet_wrap(~metric,scales="free_y")+
  geom_point(data=.%>%filter(round==0&param_set==1),
             aes(color="default"))+
  
  geom_point(data=.%>%filter(round==best_round&param_set==best_ps),
             aes(color="best"))+
  scale_y_log10() +labs(color=NULL) +
  ylab("Objective Score") + xlab("") +
  scale_color_brewer(palette="Set1")

# Objective scores by site
scores %>%
  ggplot(aes(x=param_set+round*batch_size,y=-ll*my_weight))+
  facet_wrap(~metric) +
  geom_point(aes(color=site)) +
  scale_y_log10() +
  ylab("Objective Score") + xlab("")

# Parameter search in 1D
unit_parameters %>%
  gather("parameter","unit_value",-c("param_set","round"))%>%
  ggplot(aes(x=param_set+round*batch_size,
             y=unit_value)) +
  facet_wrap(~factor(parameter,levels=param_levels)) +
  geom_point() +
  geom_point(data=.%>%filter(round==0&param_set==1),
             aes(color="default"))+
  geom_point(data=.%>%filter(round==best_round&param_set==best_ps),
             aes(color="best"))+
  scale_y_continuous(limits = c(0,1)) +
  xlab("") + ylab("Unit parameter value") +
  labs(color=NULL)+
  scale_color_brewer(palette="Set1")

emod_parameters %>%
  gather("parameter","emod_value",-c("param_set","round"))%>%
  ggplot(aes(x=param_set+round*batch_size,
             y=as.numeric(emod_value))) +
  facet_wrap(~factor(parameter,levels=param_levels),
             scales="free_y") +
  xlab("") + ylab("EMOD parameter value") +
  geom_point() +
  geom_point(data=.%>%filter(round==0&param_set==1),
             aes(color="default"))+
  geom_point(data=.%>%filter(round==best_round&param_set==best_ps),
             aes(color="best"))+
  labs(color=NULL)+
  scale_color_brewer(palette="Set1")

#### Performance plot

test_weights <-  read.csv("../reference_datasets/weights.csv")

scores %>% select(-my_weight,baseline)%>%
  #left_join(test_weights) %>%
  #mutate(ll=ll*abs(my_weight))%>%
  filter((param_set==2 & round==0) | (param_set==best_ps & round==best_round)) %>% group_by(metric,round,param_set) %>%
  summarize(ll=mean(ll))%>%
  ggplot(aes(x=interaction(round,param_set))) +
  theme(axis.text.x=element_text(angle=-90)) +
  geom_bar(aes(y=log10(-ll)),
           stat="identity",color="white") +
  labs(fill=NULL) +
  facet_grid(.~metric) 

scores %>%
  filter(metric=="no_blood") %>%
  filter(ll!=0) %>%
  select(param_set,round) %>% distinct() %>% mutate(bloodless=T) -> bloodless

scores %>%
  group_by(param_set,round)%>%
  summarize(score=sum(ll*my_weight)) %>%
  left_join(bloodless) %>%
  ggplot(aes(x=param_set+round*batch_size,y=score)) +
  geom_point(aes(color=bloodless)) +
  scale_color_manual(values=c("navy","gold"))

```





### Scores

```{r}

theme_set(theme_minimal(base_size=14))

scores %>%
  mutate(weighted_ll=ll*my_weight) %>%
  mutate(bloodless=(metric=="no_blood" & weighted_ll>0)) -> scores



scores %>% ungroup() %>%
  #filter(round==0 & param_set==1) %>%
  filter(round==0 & param_set==1) %>%
  select(site,metric,ll) -> d

scores %>% ungroup() %>%
  filter(round==0 & param_set==1) %>%
  select(site,metric,ll,baseline) -> d3

scores %>%
  mutate(weighted_ll=ll*my_weight)%>%
  group_by(round,param_set) %>%
  summarize(score=sum(weighted_ll)) %>%
  ungroup() %>%
  group_by(round) %>% filter(score==max(score)) %>%
  ungroup() %>% arrange(round) %>%
  mutate(cummax=cummax(score)) %>% 
  filter(score==cummax) -> improvements

#### Summary scores over time
scores %>%
  group_by(round,param_set) %>%
  mutate(bloodless=sum(bloodless)>0) %>% 
  ungroup() %>%
  filter(!bloodless) %>%
  group_by(round,param_set) %>%
  summarize(score=sum(weighted_ll),
            worst=max(weighted_ll),
            bloodless=sum(bloodless)) %>%
  ungroup()%>%
  mutate(ps=round*batch_size + param_set) %>% 
  ungroup() %>% 
  mutate(plotcolor=round-training_batches+2) %>% arrange(-plotcolor) %>%
  mutate(plotcolor=ifelse(plotcolor<1,1,plotcolor)) %>%
  ggplot(aes(x=ps,y=-score)) +
  geom_hline(data=.%>%filter(ps!=1) %>% filter(param_set==best_ps & round==best_round),
             aes(yintercept=-score,linetype="best"))+
  geom_point(alpha=0.33)+
  geom_point(data=.%>%filter(param_set==best_ps & round==best_round),
             aes(color="best"))+
  ylab("Total Weighted Score") + xlab("#") +
  theme_minimal(base_size=16) +
  scale_color_manual(values=my_pal[best_round+1]) +
  scale_linetype_manual(values=c(2,1)) +
  scale_y_log10()+
  labs(linetype=NULL,color=NULL)-> bp
  
  print(bp)
  ggsave(paste(score_folder,paste("scores_total.png",sep="_"),sep='/'),bp,height = 5,width=8)

  
  scores %>%
  group_by(round,param_set) %>%
  mutate(bloodless=sum(bloodless)>0) %>% 
  ungroup() %>%
  filter(!bloodless) %>%
  group_by(round,param_set) %>%
  summarize(score=sum(-ll),
            worst=max(-ll),
            bloodless=sum(bloodless)) %>%
  ungroup()%>%
  mutate(ps=round*batch_size + param_set) %>% 
  ungroup() %>% 
  mutate(plotcolor=round-training_batches+2) %>% arrange(-plotcolor) %>%
  mutate(plotcolor=ifelse(plotcolor<1,1,plotcolor)) %>%
  ggplot(aes(x=ps,y=score)) +
  geom_hline(data=.%>%filter(ps==1),
             aes(yintercept=score,linetype="default"))+
  geom_hline(data=.%>%filter(ps!=1) %>% filter(score==min(score)),
             aes(yintercept=score,linetype="best"))+
  geom_point(aes(color=my_pal[plotcolor]))+
  ylab("Total Score") + xlab("#") +
  theme_minimal(base_size=16) +
  scale_color_identity() +
  scale_linetype_manual(values=c(2,1)) +
  scale_y_log10()+
  labs(linetype=NULL) -> bp2

  bp / bp2
    
# by round

scores %>%
  group_by(round,param_set) %>%
  mutate(bloodless=sum(bloodless)>0) %>% 
  ungroup() %>%
  filter(!bloodless) %>%
  group_by(round,param_set) %>%
  summarize(score=sum(weighted_ll),
            worst=max(weighted_ll),
            bloodless=sum(bloodless)) %>%
  group_by(round) %>% filter(score==max(score))%>%
  mutate(ps=param_set+round*batch_size)  %>%
  ungroup() %>% 
  mutate(plotcolor=round-training_batches+2) %>% arrange(-plotcolor) %>%
  mutate(plotcolor=ifelse(plotcolor<1,1,plotcolor)) %>%
  ggplot(aes(x=round,y=log10(-score))) +
  geom_hline(data=.%>%filter(ps==1),
             aes(yintercept=log10(-score),linetype="default"))+
  geom_hline(data=.%>%filter(ps!=1) %>% filter((param_set==best_ps & round==best_round)),
             aes(yintercept=log10(-score),linetype="best"))+
  geom_point(data=.%>%filter(!(round%in%improvements$round)),size=2)+
  geom_point(data=.%>%filter(round%in%improvements$round),
             aes(color=my_pal[round+1], shape="improvement"),
             size=3)+
  geom_point(data=.%>%filter(param_set==best_ps & round==best_round),
             aes(color=my_pal[round+1],shape="best"),
             size=3,fill="white")+
  ylab("Log10 Total Weighted Score") + xlab("Round #") +
  theme_minimal(base_size=16) +
  scale_color_identity()+
  scale_shape_manual(values=c(22,15))+
  scale_linetype_manual(values=c(2,1)) +
  scale_y_log10()+
  labs(linetype=NULL,shape=NULL,color=NULL)-> bp
  
  print(bp)
  ggsave(paste(score_folder,paste("scores_total_by_round.png",sep="_"),sep='/'),bp,height = 8,width=8)

### All scores over time
scores %>%
  group_by(round,param_set) %>%
  mutate(bloodless=sum(bloodless)>0) %>% 
  ungroup() %>%
  filter(!bloodless) %>%
  group_by(round,param_set) %>%
  mutate(score=sum(weighted_ll),
            worst=max(weighted_ll),
            bloodless=sum(bloodless)) %>%
  mutate(ps=param_set+round*batch_size) %>%
  ungroup() %>% 
  mutate(plotcolor=round-training_batches+2) %>% arrange(-plotcolor) %>%
  mutate(plotcolor=ifelse(plotcolor<1,1,plotcolor)) %>%
  filter(metric!="no_blood") %>%
  ggplot(aes(x=ps,y=-log10(-weighted_ll))) +
  facet_wrap(metric~site) +
  geom_point(aes(color=my_pal[plotcolor]))+
  geom_hline(data=.%>%filter(ps!=1) %>% filter(param_set==best_ps & round==best_round),
             aes(yintercept=-log10(-weighted_ll),linetype="best"))+
  
  ylab("-Log10(Score)") + xlab("#") +
  theme_minimal(base_size=16) +
  theme(legend.position=c(0.9,0),
        legend.justification = c(1,0))+
  scale_color_identity() +
  scale_linetype_manual(values=c(2,1)) +
  labs(linetype=NULL)-> bp
  
  print(bp)
  ggsave(paste(score_folder,paste("scores_objective.png",sep="_"),sep='/'),bp,height =8,width=10)

scores %>%
  group_by(round,param_set) %>%
  ungroup() %>%
  group_by(round,param_set,metric) %>%
  summarize(score=sum(weighted_ll))  %>%
  mutate(ps=param_set+round*batch_size) %>%
  ungroup() %>% 
  filter(metric!="no_blood") %>%
  ggplot(aes(x=ps,y=-score)) +
  facet_wrap(~metric) +
  geom_point(alpha=0.1)+
  geom_hline(data=.%>%filter(ps!=1) %>% filter(param_set==best_ps & round==best_round),
             aes(yintercept=-score,linetype="best"))+
  
  ylab("-Log10(Score)") + xlab("#") +
  theme_minimal(base_size=16) +
  theme(legend.position=c(0.9,0),
        legend.justification = c(1,0))+
  scale_color_identity() +
  scale_y_log10() +
  scale_linetype_manual(values=c(2,1)) +
  labs(linetype=NULL)-> bp

  ggsave(paste(score_folder,paste("scores_objective_all.png",sep="_"),sep='/'),bp,height =6,width=8)
  
bp  
  
improvements %>% 
  left_join(scores) %>%
  ggplot(aes(x=param_set+round*batch_size,y=-weighted_ll)) +
  facet_wrap(~metric) +
  geom_path(aes(group=site,color=site)) +
  scale_y_log10()
  
  
# by round only

### All scores over time
scores %>%
  group_by(round,param_set) %>%
  mutate(bloodless=sum(bloodless)>0) %>% 
  ungroup() %>%
  filter(!bloodless) %>%
  group_by(round,param_set) %>%
  mutate(score=sum(weighted_ll,na.rm = T),
            worst=min(weighted_ll,na.rm=T),
            bloodless=sum(bloodless,na.rm=T)) %>%
  group_by(round) %>% filter(score==max(score)) %>%
  mutate(ps=param_set+round*batch_size) %>%
  ungroup() %>% 
  mutate(plotcolor=round-training_batches+2) %>% arrange(-plotcolor) %>%
  mutate(plotcolor=ifelse(plotcolor<1,1,plotcolor)) %>%
  #filter(metric!="no_blood") %>%
  ggplot(aes(x=factor(round,levels=sort(unique(scores$round))),y=-weighted_ll)) +
  facet_wrap(~metric) +
  #geom_point(aes(color=site),position = "identity")+
  geom_path(aes(color=site,group=site))+
  ylab("- Weighted Score") + xlab("Round #") +
  theme_minimal(base_size=16) +
  #scale_color_identity() +
  scale_y_log10()+
  scale_linetype_manual(values=c(2,1)) +
  labs(linetype=NULL)-> bp
  
  print(bp)
  
  ggsave(paste(score_folder,paste("scores_objective_by_round.png",sep="_"),sep='/'),bp,height =8,width=10)


scores %>%
  ggplot(aes(x=factor(round,levels=sort(unique(scores$round))),y=-weighted_ll)) + 
  geom_boxplot() +
  geom_point(data=.%>%filter((param_set==best_ps & round==best_round) | (param_set==2 & round==0)),
             aes(shape="best",color=metric))+
  scale_y_log10() +
  facet_wrap(~site) +
  guides(shape="none") +
  labs(color="best:") +
  xlab("Batch") + ylab("-Weighted Score")
    
### All points performance (sum)

bloodless=scores$param_set[scores$metric=="no_blood" & scores$ll<=-1] + batch_size*scores$round[scores$metric=="no_blood" & scores$ll<=-1]

scores %>%
  group_by(param_set,round) %>% mutate(score=sum(weighted_ll)) %>%
  group_by(round) %>% filter(score==max(score)) %>%
  #filter(metric!="no_blood") %>%
  ggplot(aes(x=interaction(param_set,round),y=-weighted_ll,alpha=interaction(param_set,round)%in%interaction(improvements$param_set,improvements$round))) +
  geom_bar(stat="identity",position="stack",aes(fill=metric, group=weighted_ll),color="white") +
  theme_minimal(base_size=16) +
  ylab("Score") + xlab("") +
  #scale_x_continuous(breaks=c()) +
  #scale_y_continuous(minor_breaks = seq(0,100,1)) +
  # Label component scores (unless very small, <0.5)
  geom_text(data=. %>% filter(-weighted_ll>=0),
            aes(label=ifelse(abs(weighted_ll)>1000,round(weighted_ll,2),""),group = weighted_ll),
                  position = position_stack(vjust = .5),size=3) +
  geom_text(aes(label=paste(ifelse(round<training_batches,paste("Init ",round),paste("Turbo ",round-training_batches+1)),"\n# ",param_set,sep=""),group = weighted_ll,y=-10,vjust=1.2),
            check_overlap = T,size=3) +
  labs(fill=NULL,linetype=NULL) +
  guides(alpha="none")+
  theme(legend.position="top",
        legend.box = "vertical") +
  scale_linetype_manual(values=c(2)) +
  scale_fill_brewer(palette="Set1") -> bp1
  
  print(bp1)

  ggsave(paste(score_folder,paste("scores_best_sets.png",sep="_"),sep='/'),bp1,height =12,width=8)

  
  # Valley Plot
  
  scores %>% 
    filter(!bloodless)%>%
    group_by(param_set,round) %>% 
    mutate(score=sum(weighted_ll),
              worst=min(weighted_ll)) %>%
    ungroup() %>%
    filter(worst==weighted_ll) %>% 
    mutate(score_rank=rank(-score)) %>%
    ggplot(aes(x=score_rank,y=worst)) +
    theme_minimal(base_size=14) +
    geom_point(aes(color=metric))  +
    facet_wrap(~site) +
    theme(legend.position = c(1,0),
          legend.justification.inside=c(1,0)) +
    labs(color=NULL) +
    #scale_y_log10()+
    scale_color_brewer(palette="Set1")+
    xlab("Rank of Total Score") + ylab("Worst Objective Score")
  
  
   scores %>% 
    filter(!bloodless)%>%
    group_by(param_set,round) %>% 
    mutate(score=sum(weighted_ll),
              worst=min(weighted_ll)) %>%
    ungroup() %>%
    filter(worst==weighted_ll) %>% 
    mutate(score_rank=rank(-score)) %>% 
    ggplot(aes(x=-score,y=-worst)) +
    theme_minimal(base_size=14) +
    geom_point(aes(color=metric))  +
    facet_wrap(~site) +
    theme(legend.position = "right",
          legend.justification.inside=c(1,0)) +
    labs(color=NULL) +
    #scale_x_continuous(breaks=seq(0,10000,2000)) +
    scale_x_log10() + 
    scale_y_log10() +
    scale_color_brewer(palette="Set1")+
    xlab("Total Score") + ylab("Worst Objective Score")
   
   scores %>%
     group_by(round,param_set)%>%mutate(score=sum(weighted_ll))%>%
     ggplot(aes(x=score,y=weighted_ll))+
     facet_wrap(~metric,scales="free_y") +
     geom_point(aes(color=log10(-weighted_ll))) +
     scale_color_fermenter(palette="Spectral")
   
   for(s in unique(scores$site)){
     scores %>%
     group_by(round,param_set)%>%mutate(score=sum(weighted_ll))%>%
     group_by(site,metric) %>%
        mutate(score_rank=rank(-score),objective_rank=rank(-weighted_ll)) %>%
     filter(site==s) %>%
       ggplot(aes(x=score_rank,y=objective_rank))+
     facet_wrap(~metric) +
     geom_point(aes(color=log10(-weighted_ll))) +
       coord_fixed()+
     ggtitle(s)+
     scale_color_fermenter(palette="Spectral") -> p
     print(p) 
   }
      

```


```{r,eval=F}

d %>% 
  rename(reference=ll) %>% 
  right_join(scores %>% ungroup(),by = c("metric","site")) %>% 
  select(param_set,round,ll,site,metric,reference,baseline) %>%
  mutate(reference=ifelse(metric=="no_blood",-1,reference)) %>%
  mutate(ll2=ll/baseline) %>%
  group_by(param_set,round) %>%
  mutate(worst=max(ll2,na.rm=T)) %>%
  mutate(score=sum(ll2,na.rm=T)) %>%
  ungroup() %>%
  mutate(worst=ifelse(param_set==1 & round==0,Inf,worst))%>%
  mutate(score=ifelse(param_set==1 & round==0,Inf,score))%>%
  group_by(round) %>%# count()
  filter(score==min(score) | (param_set==1 & round==0)) %>%
  arrange(round) %>%
  ungroup() %>%
  mutate(best=cummin(score)) %>%
  filter(score==best | (param_set==1&round==0)) -> track_sets

for(i in unique(track_sets$best)){
  track_sets %>% 
  filter(best==i) %>%
  ungroup() %>%
  mutate(plabel=ifelse(param_set==1 & round==0,"Default","")) %>%
  filter(plabel!="Default") %>%
  filter(metric!="no_blood") %>%
  ggplot(aes(x=gsub("_","\n",site))) + 
  geom_hline(aes(yintercept=1,linetype="reference")) +
  geom_bar(aes(group=interaction(site,metric),
                y=ll*my_weight,
                fill=metric,
               alpha=ll2==worst),
            color="transparent", alpha=0.5,
            stat="identity",
           position=position_dodge(preserve = "single", width = 1.0)) +
  facet_wrap(~paste("round",round,"#",param_set),
             nrow=2,scales="free_x") +
  scale_alpha_manual(values=c(0.5,1)) +
  scale_fill_brewer(palette="Set1") +
  labs(color=NULL,fill=NULL, alpha=NULL, linetype=NULL) +
  guides(alpha="none",fill=guide_legend(nrow = 2))+
  xlab("site") + ylab("Weighted Score") +
  coord_cartesian(ylim=c(0,4))+
  scale_linetype_manual(values=c(2)) -> bp
  
  bp + theme_minimal(base_size=16) +
    geom_hline(aes(yintercept=max(ll2))) +
    theme(legend.position="bottom") -> bp
  
  print(bp)
  ggsave(paste("output",exp,"performance",paste(i,"performance.png",sep="_"),sep='/'),bp,height = 8,width=12)
}



```

### Parameters

```{r}
# plot parameter search to visualize shrinking trust region / convergence / tradeoff

scores %>% ungroup() %>% select(round) -> pp

pp %>% group_by(round) %>% count() %>% select(round) ->pp

LFS <- list.dirs(path = glue('output/{exp}'),recursive = F)
LFS <- LFS[grepl("LF",LFS)]

for(i in seq(0,length(LFS)-1,1)){
  if(i==0){
    tp <- read.csv(paste(LFS[i+1],"translated_params.csv",sep='/'))
    tp %>% mutate(round=i) ->  tp
  } else {
    tmp <- read.csv(paste(LFS[i+1],"translated_params.csv",sep='/'))
    tmp %>% mutate(round=i) -> tmp
    tp <- rbind.data.frame(tp,tmp)
  }
}


tp %>% 
  mutate(unit_value=gsub("tensor\\(","",unit_value)) %>%
  mutate(unit_value=gsub("\\)","",unit_value)) %>%
  mutate(unit_value=as.numeric(unit_value)) %>%
  mutate(emod_value=gsub("tensor\\(","",emod_value)) %>%
  mutate(emod_value=gsub("\\)","",emod_value)) %>%
  mutate(parameter=gsub("_"," ",parameter)) -> tp
  

tp %>%
  mutate(parameter=gsub("Survival Rate","\nSurvival Rate",parameter))%>%
  mutate(parameter=gsub("Inactivation","\nInactivation",parameter))%>%
  mutate(parameter=gsub("Base","",parameter)) %>%
  mutate(parameter=gsub("Falciparum","",parameter)) %>%
  mutate(parameter=gsub("Nonspecific Anti","Nonspecific Anti-\n",parameter)) -> tp


param_levels <- unique(tp$parameter)
param_levels <- param_levels[c(1,5,10,7,6,11,12,
                               4,2,9,3,
                               14,13,8,17,15,16)]


tp %>%
  mutate(emod_value=ifelse(transformation=="log",
                           log10(as.numeric(emod_value)),
                           as.numeric(emod_value)))%>%
  ggplot(aes(x=round)) +
  facet_wrap(~factor(parameter,levels=param_levels),
             scales="free_y",ncol=3) +
    geom_segment(data=.%>%group_by(parameter,round) %>%
                   summarize(LQR=quantile(emod_value,0.25),
                             UQR=quantile(emod_value,0.75)),
             aes(xend=round,y=LQR,yend=UQR), linewidth=0.5)+
   geom_point(data=.%>%group_by(parameter,round,transformation) %>%summarize(median=median(emod_value)),
             aes(y=median,shape=transformation),fill="white")+
  geom_point(data=.%>% filter(interaction(round,param_set)%in%interaction(improvements$round,improvements$param_set)),
             aes(y=as.numeric(emod_value),color="improvement",shape=transformation),fill="white")+
  geom_point(data=.%>% filter(round==best_round & param_set==best_ps),
             aes(y=as.numeric(emod_value),color="best",shape=transformation),fill="white")+
  geom_point(data=.%>% filter(round==0 & param_set==1),
             aes(y=as.numeric(emod_value),color="default",shape=transformation),fill="white")+
  scale_color_brewer(palette="Set1",direction = -1) +
  scale_shape_manual(values=c(16,21))+
  theme_minimal(base_size=14) +
  theme(legend.position=c(1,0),
        legend.justification = c(1,0),
        legend.box = "horizontal",
        legend.direction = "vertical",
        legend.title = element_text(size=12))+
  labs(color=NULL,shape="transform") + ylab("EMOD parameter value") + xlab("Batch #") -> pp
  pp
  ggsave(paste(parameters_folder,"emod_values.png",sep='/'),pp,height = 12,width=10)

  tp %>%
  mutate(unit_value=as.numeric(unit_value))%>%
  mutate(parameter=parameter) %>%
  ggplot(aes(x=round)) +
  facet_wrap(~factor(parameter,levels=param_levels),scales="free_y",ncol=3) +
  geom_segment(data=.%>%group_by(parameter,round) %>%
                 summarize(LQR=quantile(unit_value,0.25),
                           UQR=quantile(unit_value,0.75)),
             aes(xend=round,y=LQR,yend=UQR), linewidth=0.5)+
    geom_point(data=.%>%group_by(parameter,round) %>%summarize(median=median(unit_value)),
             aes(y=median), size=1)+
  geom_point(data=.%>% filter(interaction(round,param_set)%in%interaction(improvements$round,improvements$param_set)),
             aes(y=as.numeric(unit_value),color="improvement"))+  
  geom_point(data=.%>% filter(round==best_round & param_set==best_ps),
             aes(y=as.numeric(unit_value),color="best"))+
  scale_y_continuous(limits=c(0,1))+
  scale_color_brewer(palette="Set1",direction = -1) +
  theme_minimal(base_size=14) +
  theme(legend.position=c(1,0),
        legend.justification = c(1,0),
        legend.box = "horizontal",
        legend.direction = "vertical",
        legend.title = element_text(size=12))+
  labs(color=NULL) + ylab("Unit parameter value") + xlab("Batch #") -> pp
  pp
  ggsave(paste(parameters_folder,"unit_values.png",sep='/'),pp,height = 12,width=10)
  
  
  
  
tp %>% ungroup() %>%
  filter(unit_value>=0) %>%
  ggplot(aes(x=param_set+round*batch_size,
             y=unit_value))+
  theme_minimal(base_size=12) +
  facet_wrap(~factor(parameter,levels=param_levels),ncol=3) +
  xlab("") + ylab("Unit parameter value") +
  geom_point(aes(color=factor(round))) + 
  geom_point(data=.%>%filter(param_set==best_ps & round==best_round),
             aes(shape="best"),fill="white",color="black") +
  labs(color=NULL,shape=NULL,fill=NULL) +
  theme(legend.position=c(1,0),
        legend.justification=c(1,0),
        legend.box="horizontal") +
  guides(color="none")+
  scale_shape_manual(values=c(21,16))+
  scale_color_manual(values=c(my_pal[seq(1,max(tp$round)+1)],"black","red")) -> pp
  pp
  ggsave(paste(parameters_folder,"unit_values_all.png",sep='/'),pp,height = 12,width=10)
  
library(GGally)
  
# tp %>% select(parameter,unit_value,round,param_set) %>%
#     pivot_wider(names_from = parameter,values_from = unit_value) %>%
#   select(-c(param_set))%>%
#     ggpairs(mapping = aes(color=as.factor(round)))
  
  
  tp %>%     filter(parameter %in% sample(unique(tp$parameter),4))%>%
group_by(round,parameter) %>% 
    filter(round %% 4==0)%>% 
    ggplot() +
    facet_wrap(~round,ncol=1) +
    geom_density(aes(x=unit_value,fill=parameter),
                 alpha=0.2)+
    scale_fill_manual(values=my_pal)

library(ggdensity)    
ps = sample(1:length(unique(tp$parameter)),2)  
tp %>% filter(parameter %in% unique(tp$parameter)[ps]) %>%
  filter(round%in%improvements$round)%>%
  select(parameter,unit_value,param_set,round) %>%
  pivot_wider(names_from=parameter,values_from = unit_value) %>%
  ggplot(aes(x=!!sym(unique(tp$parameter)[ps[1]]),
             y=!!sym(unique(tp$parameter)[ps[2]]))) +
  geom_hdr() +
  facet_wrap(~round)

```


```{r}
scores %>% left_join(tp %>% mutate(round=as.integer(round)) %>% select(param_set,round,parameter,unit_value)) %>% 
  mutate(score=ll*my_weight) %>%
  group_by(round,param_set,parameter,metric) %>%
  mutate(metric_score=sum(score)) %>%
  group_by(round,param_set,parameter) %>%
  mutate(total_score=sum(score)) %>%
  ungroup() -> spread_df

parameters <- unique(spread_df$parameter)
if(length(parameters)%%2==1){parameters <- c(parameters,parameters[1])}


for(i in seq(1,length(parameters),2)){
  j=i+1
  df_a <- spread_df %>% filter(parameter==parameters[i]) %>% select(param_set,round,metric,metric_score,parameter,unit_value)
  df_b <- spread_df %>% filter(parameter==parameters[j]) %>% select(param_set,round,metric,metric_score,parameter,unit_value)

  df_a  %>% 
    rbind.data.frame(df_b) %>%
    mutate(param_set=param_set+round*batch_size) %>% arrange(-param_set) %>%
    pivot_wider(names_from = parameter, values_from = unit_value, values_fn = mean) %>%
    arrange(round) %>%
    ggplot(aes(x=!!sym(parameters[i]),
               y=!!sym(parameters[j]))) +
    facet_wrap(~metric) +
    theme_minimal(base_size=12)+
    geom_point(aes(color=log10(-metric_score),
                   alpha=(round==max(round)))) +
    geom_point(data=.%>%filter(param_set==best_ps+best_round*batch_size),
               aes(shape="best"),color="black") +
    scale_color_distiller(palette="Spectral") +
    labs(color="Log10(-Score)",shape=NULL,alpha=NULL) +
    guides(alpha="none")+
    scale_shape_manual(values=c(21,16))+
    theme(legend.position="right")-> pp
  
  print(pp)
  ggsave(paste(paste(parameters_folder,"search_space",paste("separate",parameters[i],"x",parameters[j],sep="_"),sep="/"),".png",sep=''),pp,
         height=8,width=10)
}


for(i in seq(1,length(parameters),2)){
  j=i+1
  df_a <- spread_df %>% filter(parameter==parameters[i]) %>% select(param_set,round,total_score,parameter,unit_value)
  df_b <- spread_df %>% filter(parameter==parameters[j]) %>% select(param_set,round,total_score,parameter,unit_value)

  df_a  %>% 
    rbind.data.frame(df_b) %>%
    mutate(param_set=param_set+round*batch_size) %>% arrange(-param_set) %>%
    pivot_wider(names_from = parameter, values_from = unit_value, values_fn = mean) %>%
    arrange(round) %>%
    ggplot(aes(x=!!sym(parameters[i]),
               y=!!sym(parameters[j]))) +
    theme_minimal(base_size=16)+
    geom_point(aes(color=log10(-total_score),
                   alpha=round==max(round))) +
    geom_point(data=.%>%filter(param_set==best_ps+best_round*batch_size),
               aes(shape="best"),color="black") +
    scale_color_distiller(palette="Spectral") +
    labs(color="Log10(-Score)",shape=NULL,alpha=NULL) +
    guides(alpha="none")+
    scale_shape_manual(values=c(21,16))-> pp
  print(pp)
  ggsave(paste(paste(parameters_folder,"search_space",paste("total",parameters[i],"x",parameters[j],sep="_"),sep="/"),".png",sep=''),pp,
         height=6,width=6)
}


# for(i in seq(1,length(parameters),1)){
#   
#   for(j in seq(1,length(parameters),1)){
#     
#     if(i==j){
#       next
#     } else {
#       
#       df_a <- spread_df %>% filter(parameter==parameters[i]) %>% select(param_set,round,total_score,parameter,unit_value)
#       df_b <- spread_df %>% filter(parameter==parameters[j]) %>% select(param_set,round,total_score,parameter,unit_value)
#     
#       df_a  %>% 
#         rbind.data.frame(df_b) %>%
#         mutate(param_set=param_set+round*batch_size) %>% arrange(-param_set) %>%
#         pivot_wider(names_from = parameter, values_from = unit_value, values_fn = mean) %>%
#         arrange(round) %>%
#         ggplot(aes(x=!!sym(parameters[i]),
#                    y=!!sym(parameters[j]))) +
#         theme_minimal(base_size=16)+
#         geom_point(aes(color=log10(-total_score),
#                        alpha=round==max(round))) +
#         geom_point(data=.%>%filter(param_set==best_ps+best_round*batch_size),
#                    aes(shape="best"),color="black") +
#         geom_path(data=.%>%filter(param_set%in%(improvements$param_set+improvements$round*batch_size)),
#                   arrow = arrow(type="closed",length=unit(0.15,"in")), linetype=1)+
#         scale_color_distiller(palette="Spectral") +
#         labs(color="Log10(-Score)",shape=NULL,alpha=NULL) +
#         guides(alpha="none")+
#         scale_alpha_manual(values=c(0.33,1))+
#         scale_shape_manual(values=c(21,16)) -> pp
#       print(pp)
#       # ggsave(paste(paste(parameters_folder,"search_space",
#       #                    paste("total",parameters[i],"x",parameters[j],sep="_"),sep="/"),
#       #              ".png",sep=''),
#       #        pp,
#       #        height=6,width=6)
#     }
#   }
# }

```

